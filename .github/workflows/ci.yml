name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: stable
  PUB_CACHE: ~/.pub-cache

jobs:
  lint_and_test_ix_flutter:
    name: ix_flutter ${{ matrix.task }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ix_flutter
    strategy:
      matrix:
        task: [analyze, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-ix_flutter-${{ hashFiles('packages/ix_flutter/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-ix_flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Run analyzer
        if: matrix.task == 'analyze'
        run: flutter analyze

      - name: Run tests
        if: matrix.task == 'test'
        run: flutter test --coverage

      - name: Upload coverage
        if: matrix.task == 'test'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov-ix_flutter
          path: packages/ix_flutter/coverage/lcov.info
          if-no-files-found: ignore

  lint_ix_icons_generator:
    name: ix_icons_generator analyze
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ix_icons_generator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-ix_icons_generator-${{ hashFiles('packages/ix_icons_generator/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-ix_icons_generator-

      - name: Install dependencies
        run: dart pub get

      - name: Run analyzer
        run: dart analyze

  example_web_build:
    name: Example web build
    needs: [lint_and_test_ix_flutter, lint_ix_icons_generator]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-example-${{ hashFiles('example/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-example-

      - name: Install dependencies
        working-directory: example
        run: |
          flutter pub get
          flutter config --enable-web

      - name: Build web demo
        working-directory: example
        run: flutter build web --release

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: example-web-build
          path: example/build/web
          if-no-files-found: error

  publish_dry_run:
    name: Publish dry run
    needs: [lint_and_test_ix_flutter, lint_ix_icons_generator, example_web_build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-all-${{ hashFiles('packages/*/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-all-

      - name: Install ix_flutter dependencies
        working-directory: packages/ix_flutter
        run: flutter pub get

      - name: Install ix_icons_generator dependencies
        working-directory: packages/ix_icons_generator
        run: dart pub get

      - name: Validate ix_flutter package
        working-directory: packages/ix_flutter
        run: dart pub publish --dry-run

      - name: Validate ix_icons_generator package
        working-directory: packages/ix_icons_generator
        run: dart pub publish --dry-run
